name: Build & Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  swiftlint:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install SwiftLint
        run: brew install swiftlint
      - name: Run SwiftLint
        run: swiftlint --strict

  test-macos:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            xcode: '16.2'
          - os: macos-15
            xcode: '16.2'
          - os: macos-15
            xcode: '26.0'
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ matrix.xcode }}.app
      - name: Install liblzma
        run: brew install xz || true
      - name: Build
        run: swift build
      - name: Run tests
        run: swift test

  test-ios:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_26.0.app
      - name: Build for iOS
        run: xcodebuild build -scheme StreamingLZMA -destination 'generic/platform=iOS'

  swift-format:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install swift-format
        run: brew install swift-format
      - name: Download swift-format config
        run: curl -sL https://gist.githubusercontent.com/RISCfuture/e0c21afb7bd80a88d128a42bf40d2ecd/raw/.swift-format -o .swift-format
      - name: Run swift-format lint
        run: swift-format lint -rs .
